# Advanced Features

All the advanced features of this loader involve customising the `join` option.

Jump to the **"how to"** section -
  * [How to: change precedence of source locations](#how-to-change-precedence-of-source-locations)
  * [How to: fallback to a theme or other global directory](#how-to-fallback-to-a-theme-or-other-global-directory)
  * [How to: fallback to some other asset file](#how-to-fallback-to-some-other-asset-file)
  * [How to: perform a file-system search for an asset](#how-to-perform-a-file-system-search-for-an-asset)

## What is the "join" function?

The "join" function determines how CSS URIs are combined with one of the possible base paths the algorithm has identified.

⚠️ **IMPORTANT** - First read how the [algorithm](./how-it-works.md#algorithm) works.

The "join" function is a higher-order function created using the `options` and `loader` reference. That gives a function that accepts a single `item` and synchronously returns an absolute asset path to substitute back into the original CSS.

```javascript
(options:{}, loader:{}) =>
  (item:{ uri:string, query: string, isAbsolute: boolean, bases:{} }) =>
    string | null
```

Where the `bases` are absolute directory paths `{ subString, value, property, selector }` per the [algorithm](./how-it-works.md#algorithm). Note that returning `null` implies no substitution, the original relative `uri` is retained.

The job of the "join" function is to consider possible locations for the asset based on the `bases` and determine which is most appropriate. This implies some order of precedence in these locations and some file-system operation to determine if the asset there.

The default implementation is suitable for most users but can be customised per the `join` option.

A custom `join` function from scratch is possible but we've provided some [building blocks](#building-blocks) to make the task easier.

## Building blocks

There are a number of utilities (defined in [`lib/join-function/index.js`](../lib/join-function/index.js)) to help construct a custom "join" function . These are conveniently re-exported as properties of the loader.

These utilities are used to create the `defaultJoin` as follows.

```javascript
const {
  createJoinFunction,
  createJoinImplementation,
  defaultJoinGenerator,
} = require('resolve-url-loader');

// create a join function equivalent to "defaultJoin"
const myJoinFn = createJoinFunction(
  'myJoinFn',
  createJoinImplementation(defaultJoinGenerator),
});
```

🤓 If you have some very specific behaviour in mind you can specify your own implementation. This gives full control but still gives you `debug` logging for free.

```javascript
createJoinFunction = (name:string, implementation: function): function
```

For each item, the implementation needs to make multiple attempts at locating the asset. It has mixed concerns of itentifying locations to search and then evaluating those locates one by one.

👉 However its recommended to instead use `createJoinImplementation` to create the `implementation` using the `generator` concept.

```javascript
createJoinImplementation = (generator: function*): function
```

The `generator` has the single concern of identifying locations to search. The work of searching these locations is done by `createJoinImplementation`. Overall this means less boilerplate code for you to write.

Don't worry, you don't need to use `function*` semantics for the `generator` unless you want to.

## Simple customisation

It is relatively simple to change the precedence of values (from the [algorithm](./how-it-works.md#algorithm)) or add further locations to search for an asset. To do this we use `createJoinImplementation` and write a custom `generator`.

See the reference or jump directly to the [examples](#how-to-change-precedence-of-source-locations).

### Reference

The `generator` identifies `[base:string,uri:string]` tuples describing locations to search for an asset. It does **not** return the final asset path.

You may lazily generate tuples as `Iterator`. Refer to this [guide on Iterators and Generators](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators).
```javascript
generator = function* (item: {}, options: {}, loader: {}): Iterator<[string,string]>
```

Or it can be simpler to write a function that returns `Array` and convert it to a generator using `asGenerator`.

```javascript
generator = asGenerator( function (item: {}, options: {}, loader: {}): Array<string> )
```
```javascript
generator = asGenerator( function (item: {}, options: {}, loader: {}): Array<[string,string]> )
```

When using `asGenerator` you may return elements as either `base:string` **or** `[base:string,uri:string]` tuples.

<details>
<summary>Arguments</summary>

* `item` consist of -
  * `uri: string` is the argument to the `url()` as it appears in the source file.
  * `query: string` is any query or hash string starting with `?` or `#` that suffixes the `uri`
  * `isAbsolute: boolean` flag indicates whether the URI is considered an absolute file or root relative path by webpack's definition. Absolute URIs are only processed if the `root` option is specified.
  * `bases: {}` are a hash where the keys are the sourcemap evaluation locations in the [algorithm](./how-it-works.md#algorithm) and the values are absolute paths that the sourcemap reports. These directories might not actually exist.
* `options` consist of -
   * All documented options for the loader.
   * Any other values you include in the loader configuration for your own purposes.
* `loader` consists of the webpack loader API, useful items include -
   * `fs: {}` the virtual file-system from Webpack.
   * `resourcePath: string` the source file currently being processed.
* returns an `Iterator` with elements of `[base:string,uri:string]` either intrinsically or by using `asGenerator`.
</details>

<details>
<summary>FAQ</summary>

* **Why a tuple?**

  The primary pupose of this loader is to find the correct `base` path for your `uri`. By returning a list of paths to search we can better generate `debug` logging.
  
  That said there are cases where you might want to amend the `uri`. The solution is to make each element a tuple of `base` and `uri` representing a potential location to find the asset.
  
  If you're interested only in the `base` path and don't intend to vary the `uri` then the `asGenerator` utility saves you having to create repetative tuples (and from using `function*` semantics).

* **Can I vary the `query` using the tuple?**

  No. We don't support amending the `query` in the final value. If you would like this enh